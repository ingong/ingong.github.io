{"componentChunkName":"component---src-templates-blog-post-js","path":"/React/Recoil로의 마이그레이션/","result":{"data":{"site":{"siteMetadata":{"title":"Ingong's Log","author":"ingong","siteUrl":"https://ingong.github.io","comment":{"disqusShortName":"","utterances":"ingong/ingong.github.io"},"sponsor":{"buyMeACoffeeId":"ingong"}}},"markdownRemark":{"id":"5773816a-f2a8-58bd-a502-69e876664506","excerpt":"TL;DR Context API 와 Reducer 를 활용한 상태관리에서 느꼈던 불편함을 정리했다. 마이그레이션은 일종의 리팩토링이다. 같은 동작을 보장하기 위해 우리는 테스트 코드를 작성을 시도했지만 실패했다. 기능 명세를 기반으로 Recoil 로의 마이그레이션을 성공하고, 상태 관리 라이브러리를 왜 쓰는지를 체감했다. 부스트 캠프 팀프로젝트인 HyupUp…","html":"<h3 id=\"tldr\" style=\"position:relative;\"><a href=\"#tldr\" aria-label=\"tldr permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TL;DR</h3>\n<ul>\n<li>Context API 와 Reducer 를 활용한 상태관리에서 느꼈던 불편함을 정리했다.</li>\n<li>마이그레이션은 일종의 리팩토링이다. 같은 동작을 보장하기 위해 우리는 테스트 코드를 작성을 시도했지만 실패했다.</li>\n<li>기능 명세를 기반으로 Recoil 로의 마이그레이션을 성공하고, 상태 관리 라이브러리를 왜 쓰는지를 체감했다.</li>\n</ul>\n<p>부스트 캠프 팀프로젝트인 HyupUp 에서 우리는 상태 관리에 대해 고민했다. 첫 번째 고민은 상태 관리 대상과 구조였으며, 이를 해결한 후 상태 관리를 어떻게 할지 고민을 시작했다. 우리는 이전 JavaScript 의 뜨거운 맛을 보고, React 의 달콤함을 경험했던 것처럼 상태관리에서도 경험해보고 싶었다. 우리의 상태 관리 방법에 대한 도전기를 간단하게 정리해보고, 느낀 점을 정리해보려한다.</p>\n<br>\n<h2 id=\"context-api-와-reducer-로-상태-관리하기\" style=\"position:relative;\"><a href=\"#context-api-%EC%99%80-reducer-%EB%A1%9C-%EC%83%81%ED%83%9C-%EA%B4%80%EB%A6%AC%ED%95%98%EA%B8%B0\" aria-label=\"context api 와 reducer 로 상태 관리하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Context API 와 Reducer 로 상태 관리하기</h2>\n<p>이전 글에서 우리가 전역적으로 관리했던 상태에 대해서 다뤘지만, 아직 읽지 않은 분들이 계실 수 있어서 간략하게 요약하면 다음과 같다. User 가 존재하며, 하나의 조직에 속할 수 있으며, 여러개의 프로젝트에 참여할 수 있다. 하나의 프로젝트에는 여러 개의 에픽이 존재하며, 하나의 에픽에는 여러 개의 스토리가, 하나의 스토리에는 여러 개의 테스크가 존재한다. 다음 그림을 보면 충분히 이해가 될 것이라고 생각한다.</p>\n<br>\n<div align=\"center\">\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 591px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 48.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAACm0lEQVQozzWSS0iUURSAZxct2rRoWxQFQYto0y4IgsCNG9NeixYhkUVERhIRFlo+srJMDdOyzNJM0x4+RzNHHfA1PrPSeTmTM/97Zv4Zn/F1Z8TF4XLP4X7nO4drUV1DhG2lhPtKMMYa0B1N6P5p3D4XJY3fyanppHVghMHxSZ6K+5uOAbyuP4S//kDrsaO32dCtg+jt/ciyB8tayWHWC/ZsRNF+Vu/uAOstqq0OLEn32X6ymLR79Ry89ELc89l7sYLGD92QUkjkYjlLpx4SO/uYaEY5yqILy7+8XawX7mM9fzdrxYeIvU6F6uO09nRzuewbZc299I6Mc/5REwXvumiwDTPdP0xUQMwbL4leKCWW/gzzZjXKX+eGYawxA7M9m+WaNIKLTtZnGmmpq2BrainbUoo4kVtH0u1atiQ/YGd6OW1f+uDcE8LXq4idL0lAzczKDcOVsiOonjFB/52ABlSJtb8j1NW/JTmngdyaDt53DXI06zXpwvJBkzButbGSnId56Tmx02LkM2Lkqy9Q/MIwMtmC4R1H9c+izVrFYn3owTnm3XP8cs4TCLiRJC/2iSm8C05cPqcQmEO3j6GPTqAPOdD6htCGHShBN5ZQNIJhSKi6jNF5B23yM5IaxFAXiEYUQkZQhARLEvW2GWp6Z4iGfGhRmbCpYiDeW+2Y1yqRtQUscsCJLMiy5MGsPIbRW4RsqMiBeSRhF68FxRnRPGR/dJBZO0pY9SCLfcVHlGKLRPLqWD2QieL+g0WR3ELVhawGCLVcQZtoFp2kRE4RTeKN4sBlw0tV9zQVXVMsh7yJnBIQ78xFDPEn499HNnwCGNwEikJPAeqvngR8ExiPuGlM9/LJ/pNm+yxLxiZQTBD2ow2OYGa9Qg75+Q/mapB0AB/xjQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"HyupUp\" title=\"HyupUp\" src=\"/static/1eebb5ac2b19a9fb6c205aee904db612/e4c9a/HyupUp.png\" srcset=\"/static/1eebb5ac2b19a9fb6c205aee904db612/5a46d/HyupUp.png 300w,\n/static/1eebb5ac2b19a9fb6c205aee904db612/e4c9a/HyupUp.png 591w\" sizes=\"(max-width: 591px) 100vw, 591px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n</div>\n<br>\n<p>우리는 치열한 의사소통 끝에 User, 에픽, 스토리를 전역적으로 관리하기로 했다. 우리는 개발 3주차까지 상태 관리 라이브러리를 사용하지 않았기 때문에 context 객체를 만들고, 컴포넌트가 이 context 를 가지도록 해당 컴포넌트 상위에 <code class=\"language-text\">provider</code> 로 부턱 context 를 정의한 변수를 감쌌다. User 에 대한 상태가 비교적 간단해 UserContext 코드를 가져왔다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> UserContext <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">createContext</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>ContextType<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  userState<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n  dispatch<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">UserProvider</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> children <span class=\"token punctuation\">}</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> children<span class=\"token operator\">:</span> React<span class=\"token punctuation\">.</span>ReactNode <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>userState<span class=\"token punctuation\">,</span> dispatch<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useReducer</span><span class=\"token punctuation\">(</span>reducer<span class=\"token punctuation\">,</span> user<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UserContext.Provider</span></span> <span class=\"token attr-name\">value</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> userState<span class=\"token punctuation\">,</span> dispatch <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token punctuation\">{</span>children<span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">UserContext.Provider</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>상태에 변화를 주는 방법은 Reducer 로 정의했다. reducer 에 Action 을 정의하고, 해당 Action 에 따라서 코드가 실행되도록 했다. User 에 대한 reducer 코드는 50줄이였기 때문에 얼마나 길었는지 보여주기 위해 UserAction 에 대한 Type 정의 코드를 가져왔다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">type</span> <span class=\"token class-name\">UserAction</span> <span class=\"token operator\">=</span>\n  <span class=\"token operator\">|</span> <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">'GET_USER'</span><span class=\"token punctuation\">;</span> payload<span class=\"token operator\">:</span> UserState <span class=\"token punctuation\">}</span>\n  <span class=\"token operator\">|</span> <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">'LOGOUT'</span> <span class=\"token punctuation\">}</span>\n  <span class=\"token operator\">|</span> <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">'UPDATE_USER'</span><span class=\"token punctuation\">;</span> payload<span class=\"token operator\">:</span> UserState <span class=\"token punctuation\">}</span>\n  <span class=\"token operator\">|</span> <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">'ADD_PRIVATE_TASK'</span><span class=\"token punctuation\">;</span> payload<span class=\"token operator\">:</span> PrivateTask <span class=\"token punctuation\">}</span>\n  <span class=\"token operator\">|</span> <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">'DELETE_PRIVATE_TASK'</span><span class=\"token punctuation\">;</span> payload<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token punctuation\">}</span>\n  <span class=\"token operator\">|</span> <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">'UPDATE_PRIVATE_TASK'</span><span class=\"token punctuation\">;</span> payload<span class=\"token operator\">:</span> PrivateTask <span class=\"token punctuation\">}</span>\n  <span class=\"token operator\">|</span> <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">'UPDATE_PROJECT_TASK'</span><span class=\"token punctuation\">;</span> payload<span class=\"token operator\">:</span> PrivateTask <span class=\"token punctuation\">}</span></code></pre></div>\n<p>우리는 상태를 정의하고, 변경을 정의하는 과정에서 보일러 플레이트 코드가 정말 많다는 느낌을 받았다. 새로운 상태변화 로직이 필요할 때마다 액션을 새로 정의하거나, 기존 코드를 수정해야했다. 이 시점에 Recoil 을 사용해보지는 않았지만, 하나씩 정의할 때보다는 코드를 줄여줄 것으로 내심 기대했다.</p>\n<p>코드 차원에서의 복잡도도 문제였지만, 상태 자체의 복잡도도 존재했다. 다음은 우리가 정의한 <code class=\"language-text\">UserState</code> 이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\">UserState <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  id<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span>\n  name<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n  job<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n  email<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n  imageURL<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n  admin<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span><span class=\"token punctuation\">;</span>\n  organization<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span>\n  currentProjectName<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n  currentProjectId<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span>\n  projects<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Array</span><span class=\"token operator\">&lt;</span>ProjectType<span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n  privateTasks<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Array</span><span class=\"token operator\">&lt;</span>PrivateTask<span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n  projectTasks<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Array</span><span class=\"token operator\">&lt;</span>ProjectTask<span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">UserState</code>에는 개인 할 일(privateTasks)배열과 프로젝트에서의 할 일(projectTasks)배열이 있다. 이 둘을 불변성을 지키면서 변경시키는 것은 꽤나 복잡했다. 게다가 이 둘을 사용하는 <code class=\"language-text\">ListView</code> 컴포넌트의 경우 두 프로퍼티 외 다른 프로퍼티들을 참조하지도 않았다. 즉, 컴포넌트에서 필요한 상태 외 다른 상태를 가져와야만 했고, 객체에 프로퍼티에 접근하고 이를 변경시켜야만 했다. 그렇다고 위 둘을 분리하기에는 새로운 context를 만드는 것이 부담이기도 했고, 다른 프로퍼티와 연관이 아예 없는 것도 아니었다.</p>\n<p>심지어 <code class=\"language-text\">EpicState</code>, <code class=\"language-text\">StoryState</code> 의 상태 관리의 복잡도는 더 컸다. 두 가지 상태 모두 사용자의 인터렉션에 의해 빈번하게 상태가 변화했기 때문이다. 따라서 우리는 4주차의 시작 시점에 마이그레이션을 적용할 시점이라고 판단하고, 마이그레이션을 시작했다. 마이그레이션을 통해서 우리는 기존에 정상 동작을 보장하고, 코드만 수정해야했고 이를 어떻게 보장할지 고민했다.</p>\n<h2 id=\"정상-동작을-보장하기-위한-노력\" style=\"position:relative;\"><a href=\"#%EC%A0%95%EC%83%81-%EB%8F%99%EC%9E%91%EC%9D%84-%EB%B3%B4%EC%9E%A5%ED%95%98%EA%B8%B0-%EC%9C%84%ED%95%9C-%EB%85%B8%EB%A0%A5\" aria-label=\"정상 동작을 보장하기 위한 노력 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>정상 동작을 보장하기 위한 노력</h2>\n<p>필자는 꼭 테스트로 이 과정을 보장하고 싶었다. 테스트 코드에 대한 경험이 없었고, 이 경험이 없었기 때문에 더욱 시도해보고 싶었다. 우리가 기획 단계에서 작성한 백로그에서는 프론트 엔드 테스트 코드 작성에 대한 내용이 없었다. 당연하게 주말을 할애해서 테스트 환경을 구축해야했고, 워낙 열정이 넘칠 때라 자신감있게 시도했다. 칸반 보드 내에서 스토리를 담당했어서, 해당 기능의 정상 동작을 보장하기 위해 먼저 테스트 환경을 구축했다.</p>\n<p>생각보다 환경을 구축하는 과정부터 어려웠다. React 훅을 테스팅하려면 컴포넌트의 환경과 동일하게 구축해야했고, 우리는 Context API 를 사용했기 때문에 이에 대한 환경 구축이 필요했다. 다음은 CustomRender 를 작성한 코드이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">import</span> React<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> ComponentType<span class=\"token punctuation\">,</span> ReactElement <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> render <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@testing-library/react'</span>\n<span class=\"token keyword\">import</span> theme <span class=\"token keyword\">from</span> <span class=\"token string\">'client/src/styles/theme'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> ThemeProvider <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'styled-components'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> StoryProvider <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'client/src/contexts/storyContext'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> EpicProvider <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'client/src/contexts/epicContext'</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">CustomProvider</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> children <span class=\"token punctuation\">}</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> children<span class=\"token operator\">:</span> React<span class=\"token punctuation\">.</span><span class=\"token constant\">FC</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ThemeProvider</span></span> <span class=\"token attr-name\">theme</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>theme<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">EpicProvider</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">StoryProvider</span></span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>children<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">StoryProvider</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">EpicProvider</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">ThemeProvider</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">CustomRender</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>ui<span class=\"token operator\">:</span> ReactElement<span class=\"token punctuation\">,</span> options<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">render</span><span class=\"token punctuation\">(</span>ui<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> wrapper<span class=\"token operator\">:</span> CustomProvider <span class=\"token keyword\">as</span> ComponentType<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>options <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> CustomRender</code></pre></div>\n<p>이번 글의 목적이 테스팅은 아니기 때문에 이 코드에 대한 설명은 생략하겠다. 뿐만 아니라 svgTransform 코드도 작성해야했고 이외 여러가지 외부 모듈을 설치하면서 이슈들을 하나씩 해결해나갔다. 정말 테스트를 제대로 작성하지 못하다면 슬플 것 같았다.</p>\n<p>결론부터 말하자면 스토리 아이템 컴포넌트와 스토리 추가 컴포넌트에 대해서는 테스트 작성을 성공했다. 기능 명세를 토대로 테스트를 작성했고, 통과됐다. 사실 이미 구현한 기능에 대해서 테스트를 작성하면서 굳이 왜 해야하는지 의구심이 들었지만 일단 시도했고, 성공은 했다.</p>\n<p>이제는 리코일에 대해서 테스팅만 하면 됐다. 원래 목표는 주말 내에 완성이였지만, 이 테스트를 도입하고 나니 시간은 일요일 저녁이였다. Recoil 테스트에 대해서 찾아보고 자야지 생각하고 구글링을 시도했다. 구글링에서 결과가 많이 나오지 않아서 당황했지만, 내일의 내 자신이 해결할 것이라고 생각하고 일단 구글링을 멈췄다.</p>\n<p>월요일, 화요일, 수요일 3일동안 맡은 기능 개발을 마무리한 후에는, 리코일 테스트를 시도했다. 결과는 실패였다. 나는 Unit Test 를 시도했지만, 이미 Recoil 로 코드를 작성한 이후부터 어려운 것 같았다. 그리고 내가 테스트를 작성한 목적에 대해서 다시 생각해봤다. 나는 정상동작을 보장하기 위해 테스트를 작성했지만, Recoil 로 마이그레이션을 하기 위해 또 별도의 테스트 코드를 작성해야했다.</p>\n<p>개발 리소스를 고려했을 때, 과연 이게 팀의 서비스 완성도를 위해 올바른 선택인지 고민하는 순간이였다. 팀원들에게 의견을 전달하고, 테스트 코드 작성을 유보했다. 6주 기간 동안에 도입은 힘들다고 생각했고, 우리는 백로그에 작성한 사용자 동작을 기반으로 정상 동작 보장을 하기로 했다. 한 줄이면 끝날 수 있었던 정상 동작 보장을 위한 노력이 결과물이 없어 아쉬웠다. 하지만 목표를 세우고 몰입했던 경험이 나쁘지 않았다는 생각도 들었고, 나중에는 꼭 해결해보고 싶다는 다짐을 했다.</p>\n<h2 id=\"recoil-로-마이그레이션하기\" style=\"position:relative;\"><a href=\"#recoil-%EB%A1%9C-%EB%A7%88%EC%9D%B4%EA%B7%B8%EB%A0%88%EC%9D%B4%EC%85%98%ED%95%98%EA%B8%B0\" aria-label=\"recoil 로 마이그레이션하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recoil 로 마이그레이션하기</h2>\n<p>다른 팀원이였던 해수님이 Recoil 로 마이그레이션을 성공하고, 관련한 내용을 공유해주셨다. 말씀해주신 내용과 Recoil 공식 문서를 토대로 코드를 작성했고, 생각보다 빠르게 적용할 수 있었다. 워낙 훅과 사용방법이 유사해서 이틀 정도를 투자해 마이그레이션을 할 수 있었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token comment\">// recoil/Story/atom.ts</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> atom <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'recoil'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> StoryListType <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@/types/story'</span>\n\n<span class=\"token keyword\">const</span> storyListAtom <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">atom</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>StoryListType<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  key<span class=\"token operator\">:</span> <span class=\"token string\">'storyListAtom'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">default</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> storyListAtom</code></pre></div>\n<p><code class=\"language-text\">atom</code>이라는 키워드로 상태를 담고 컴포넌트 최상단을 <code class=\"language-text\">RecoilRoot</code> 로 감싸기만 하면 끝이였다. 복잡한 정의도 필요 없어서 기존의 <strong>Context API를 사용하던 것에 비해 훨씬 간단</strong>해졌다. 상태의 변경 또한 매우 간단했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> useRecoilState<span class=\"token punctuation\">,</span> useRecoilValue <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'recoil'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> storyListAtom <span class=\"token keyword\">from</span> <span class=\"token string\">'@/recoil/story/atom'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> userAtom <span class=\"token keyword\">from</span> <span class=\"token string\">'@/recoil/user'</span><span class=\"token punctuation\">;</span>\n\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">KanbanColumn</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  category<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token operator\">:</span> KanbanType<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>storyList<span class=\"token punctuation\">,</span> setStoryList<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useRecoilState</span><span class=\"token punctuation\">(</span>storyListAtom<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// KanbanColum Code</span></code></pre></div>\n<p>스토리 배열에서 key 에 해당하는 아이템만 가져오기 위해서는 Selector 를 사용해야했으며, 다음과 같이 정의하면서 사용할 수 있었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token comment\">// recoil/Story/selector.ts</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> DefaultValue<span class=\"token punctuation\">,</span> selectorFamily <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'recoil'</span>\n<span class=\"token keyword\">import</span> storyListAtom <span class=\"token keyword\">from</span> <span class=\"token string\">'./atom'</span>\n<span class=\"token comment\">// import</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> storyState <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">selectorFamily</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>StoryType <span class=\"token operator\">|</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  key<span class=\"token operator\">:</span> <span class=\"token string\">'storyWithIdSelector'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function-variable function\">get</span><span class=\"token operator\">:</span> id <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> get <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> storyList <span class=\"token operator\">=</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span>storyListAtom<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> storyList<span class=\"token operator\">?.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span>story <span class=\"token operator\">=></span> story<span class=\"token punctuation\">.</span>id <span class=\"token operator\">===</span> id<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function-variable function\">set</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>id<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> set<span class=\"token punctuation\">,</span> get <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> newValue<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">set</span><span class=\"token punctuation\">(</span>\n      storyListAtom<span class=\"token punctuation\">,</span>\n      newValue <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">DefaultValue</span>\n        <span class=\"token operator\">?</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span>storyListAtom<span class=\"token punctuation\">)</span>\n        <span class=\"token operator\">:</span> prev <span class=\"token operator\">=></span>\n            <span class=\"token function\">produce</span><span class=\"token punctuation\">(</span>prev<span class=\"token punctuation\">,</span> draft <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n              <span class=\"token keyword\">const</span> newStoryIdx <span class=\"token operator\">=</span> draft<span class=\"token operator\">?.</span><span class=\"token function\">findIndex</span><span class=\"token punctuation\">(</span>story <span class=\"token operator\">=></span> story<span class=\"token punctuation\">.</span>id <span class=\"token operator\">===</span> id<span class=\"token punctuation\">)</span>\n              <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newStoryIdx <span class=\"token operator\">===</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>newValue<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span>\n              draft<span class=\"token punctuation\">[</span>newStoryIdx<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> newValue\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>위처럼 id 를 인자로 받아와서 가져오도록 작성한다면 끝이였다. 이를 통해 하나의 스토리 아이템을 가져와야하는 컴포넌트에서 굳이 배열 전체 상태를 가져올 필요가 없어졌다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token comment\">// client/src/components/KanbanColumn/KanbanItemInput</span>\n<span class=\"token keyword\">const</span> updateStoryName <span class=\"token operator\">=</span> <span class=\"token function\">useSetRecoilState</span><span class=\"token punctuation\">(</span><span class=\"token function\">storyState</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>다음과 같이 코드를 작성해 원하는 스토리를 가져올 수 있었다.</p>\n<h2 id=\"마무리\" style=\"position:relative;\"><a href=\"#%EB%A7%88%EB%AC%B4%EB%A6%AC\" aria-label=\"마무리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>마무리</h2>\n<p>우려와 달리 우리는 리코일을 생각보다 어렵지 않게 도입할 수 있었다. Recoil 을 사용하면서 체감했던 장점을 정리해보면 다음과 같다. 먼저 러닝커브가 낮았다. Redux 를 도입을 고려했지만 최종적으로 Recoil 을 도입한 가장 중요한 계기였다. 두 번째로 코드량이 눈에 띄게 감소했다. <code class=\"language-text\">atom</code> 함수 하나로 간단하게 전역상태를 만들 수 있었고, 이는 기존의 <code class=\"language-text\">context</code> 에 비해 훨씬 코드가 간결했다. 마지막으로 원하는 상태만을 컴포넌트에서 가져와 사용할 수 있었다. <code class=\"language-text\">selector</code> 키워드로 상태를 분리해 관리할 수 있게 되었고, 필요한 부분만 조회하고 수정하는게 가능해졌다.</p>\n<p>짧은 기간 동안 Recoil 을 사용하면서 아쉬웠던 점도 역시 있었다. 먼저 레퍼런스가 부족했다. 대부분의 블로그들은 리코일의 공식 문서를 학습한 내용들이였고, 스택오버플로우에 답변도 Redux 에 비하면 현저하게 적었다. 두 번째는 테스트 코드 작성의 어려움이다. 레퍼런스가 없다보니 당연히 테스트 코드에 대한 레퍼런스도 부족했다. 마지막은 캐싱 지원 부분이다. 개발한 HyupUp 서비스는 실시간으로 상태가 변화하고 동기화되어야했고, 오히려 이 캐싱 기능은 방해가 되었다. 현재 unstable 단계인 <code class=\"language-text\">useRecoilRefresher</code> 을 사용하여 해결할 수 있지만, unStable 단계여서 get 내부에서 비동기 로직을 작성하지 않았다.</p>","frontmatter":{"title":"Recoil Migration","date":"December 05, 2021"}}},"pageContext":{"slug":"/React/Recoil로의 마이그레이션/","previous":{"fields":{"slug":"/FrontEnd/상태관리대상과 구조/"},"frontmatter":{"title":"상태관리의 대상과 구조"}},"next":{"fields":{"slug":"/FrontEnd/칸반보드와 UX 개선/"},"frontmatter":{"title":"칸반보드와 UX 개선"}}}},"staticQueryHashes":["2486386679","3128451518"]}